//
//  ContentView.swift
//  Watchleste Watch App
//
//  Created by r58playz on 12/29/23.
//

import SwiftUI

let MAPDATA: NSString = "2331252548252532323232323300002425262425252631323232252628282824252525252525323328382828312525253232323233000000313232323232323232330000002432323233313232322525252525482525252525252526282824252548252525262828282824254825252526282828283132323225482525252525252331323232332900002829000000242526313232332828002824262a102824254825252526002a2828292810244825282828290000000028282900000000002810000000372829000000002a2831482525252525482525323232332828242525254825323338282a283132252548252628382828282a2a2831323232322525252523201028380000002a0000003d24252523201028292900282426003a382425252548253300002900002a0031252528382900003a676838280000000000003828393e003a2800000000000028002425253232323232332122222328282425252532332828282900002a283132252526282828282900002a282828382824483232332828282900000000003f2020244825262828290000002a243300002a2425322525260000000000000000003125290000000021222328280000000000002a2828343536290000000000002839242526212223202123313232332828242548262b000000000000001c00003b2425262828280000000000282828282824252340283828293a2839000000343522252548262900000000000030000000002433003125333d3f00000000000000003100001c3a3a31252620283900000000000010282828290000000011113a2828313233242526103133202828282838242525262b000000000000000000003b2425262a2828670016002a28283828282425263a282828102829000000000000312525323300000000110000370000003e2400000037212223000000000000000000395868282828242628290000000000002a2828290000000000002123283828292828313233282829002a002a2828242525332b0c00000011110000000c3b314826112810000000006828282828282425252235353628280000000000003a282426003d003a3900270000000000002125001a000024252611111111000000002c28382828283831332800000017170000002a000000001111000024261028290028281b1b1b282800000000002a2125482628390000003b34362b000000002824252328283a67003a28282829002a313225333828282900000000000000283824252320201029003039000000005824480000003a31323235353536675800003c282828281028212329000000000000000000000000003436003a2426282800003828390000002a29000000000031323226101000000000282839000000002a24253328282838002828283900000017002600002a28000000003a283a2828282425252223283900372858390068283132000000282828282820202828283921222829002a28282426000000000000000000000000000020382828312523000000282828290000000000163a67682828003338280b00000010382800000b00003133282828282868282828280000001700330000002867580000281028283422252525482628286720282828382828212200003a283828102900002a28382824252a0000002838242600000017170000000000000000002728282a283133390000282900000000000000002a28282829002a2839000000002a2829000000000000282828382828282828282900000000000000003a2828383e3a2828283828242548252526002a282729002a28283432250000002a282828000000002810282425000000002a282426000000000000000000000000000037280000002a28283900280000003928390000000000282800000028290000002a2828000000000000002a2828282810282828286758000000000000002838282821232800002a28242532322526003a2830000000002a28282400000000002a281111111128282824480000003a28283133000000000000171700013f0000002029000000003828000028013a28281028580000003a28290000002a280c0000003a380c00000000000c00002a2828282828292828290000003a00013a2123282a313329001111112425002831263a3829300000000000002a310000000000002834222236292a0024253e013a3828292a00000000000000000035353536000020000000003d2a28671422222328282828283900582838283d00003a290000000028280000000000000000002a28282a29000058100012002a2822222225262900212311112122222525002a3837282900301111110000003a2800013f0000002a282426290000002425222222232900000000000000171700002a282039003a2000003a003435353535252525222222232828282810282821220b10000000000b28100000000b0000002c00002838000000002a2839170000282548252526111124252222252525482500012a2828673f242222230000003828222223000012002a24260000001224252525252600000000171700000000000000382028392827080028676820282828254825252525262a28282122222225253a28013d0000006828390000000000003c0168282800171717003a2800003a2825252525252222252525252525252525222222222222222525482667586828282548260000270000242600000021252525254826171700000000000000000000002a2028102830003a282828202828282525252548252600002a2425252548252821222300000028282800000000000022222223286700000000282839002838253233000000243232323232323225252525262828282824253232323225482525323232323232322526282828244825252525330000000000000000000000522525323232323331323232323328290026282928670000000000282831323232252525323328280031252548252525482525482628382831323232323232254826282800000030402a282828282824252548262838282831333828290031322526280000163a28283133282838242525482526000000000000000000000000522526000016000000002a10282838390026281a3820393d000000002a3828282825252628282829003b24253232323232323232332828282828281028282031253328390000003700002a3828002a2425252526282828282028292a0000002a313328111111282828000028002a312525252526000000000000000000000000522526000000001111000000292a28290026283a2820102011111121222328281025252628382800003b24262b002a2a38282828282829002a280028283828283128281029000000000000282839002448252526282900282067000000000000003810212223283829003a1029002a242532323367000000000000000000004200252639000000212300000000002122222522222321222321222324482628282832323328282800003b31332b00000028102829000000000029002a28282829002828280016000000162a2828280024252525262700002a2029000000000000002834252533292a0000002a00111124252223282800002c46472c00000042535325262800003a242600001600002425252525482631323331323324252620283822222328292867000028290000000000283800111100001200000028292a1600283828000000000000003a28290024254825263700000029000000000000003a293b2426283900000000003b212225252526382867003c56573c4243435363633233283900282426111111111124252525482526201b1b1b1b1b24252628282825252600002a28143a2900000000000028293b212300001700001128670000002828286758000000586828380000313232323320000000000000000000272828003b2426290000000000003b312548252533282828392122222352535364000029002a28382831323535353522254825252525252300000000003132332810284825261111113435361111111100000000003b3133111111111127282900003b2828282810290000002a28286700002835353536111100000000000011302838003b3133000000000000002a28313225262a282810282425252662636400000000160028282829000000000031322525252525252667580000002000002a28282525323535352222222222353639000000003b34353535353536303800000017282900002a0000000000382a29003a282828283436200000000000002030282800002a29000011110000000028282831260029002a282448252523000000000039003a282900000000000000002831322525482526382900000017000058682832331028293b2448252526282828000000003b201b1b1b1b1b1b302800000017283a0000000000000000280000002828283810292a000000000000002a3710281111111111112136000000002a28380b2600000000212525252526001c0000002828281000000000001100002a382829252525252628000000001700002a212228282908003b242525482628282912000000001b00000000000030290000003b3829000000000000003a102900002838282828000000000000000000002a2828223535353535330000000000002828393300000000313225252533000000000028382829000000003b202b00682828003232323233290000000000000000312528280000003b3132322526382800170000000000000000110000370000000000290000000000000000002a000000282928292a0000000000000000000000282a332838282829000000000000001028280000000042434424252628390000000028002a0000110000001b002a2010292c1b1b1b1b0000000000000000000010312829160000001b1b1b313328106700000000001100003a2700001b000000000000000100000011111100000000002a3a2a0000000000000000000000002a2800282829002a000000000000000028282800000000525354244826282800000000290000003b202b39000000002900003c000000000000000000000000000028282800000000000000001b1b2a28290000010000273900383000000000000000001111201111112122230000001212002a00010000000000000000000000002900290000000000000000002a6768282900003f01005253542425262810673a3900013f0000002a3829001100000000002101000000000000003a67000000002a38286758680000010000000068280000002123003728292830000000000000000022222222222324482611111120201111002739000017170000001717000000000001000000001717000000282838393a0021222352535424253328282838290022232b00000828393b27000000001424230000001200000028290000000000282828102867001717171717282839000031333927101228370000000000000000254825252526242526212222222222223a303800000000000000000000000000001717000000000000003a28282828280024252652535424262828282828283925262b00003a28103b30000000212225260000002700003a28000000000000282838282828390000005868283828000022233830281728270000000000000000";
let SPRITES: NSString = "000000000000000000000000088888800000000000000000000000000000000000aaaaa0000aaa000000a0000007707770077700000060000000600000060000000000000888888008888880888888880888888008888800000000000888888000a000a0000a0a000000a0000777777677777770000060000000600000060000000000008888888888888888888ffff888888888888888800888888088f1ff1800a909a0000a0a000000a000776666666776777700060000000060000006000000000000888ffff8888ffff888f1ff18888ffff88ffff8808888888888fffff8009aaa900009a9000000a00076777666766666770006000000006000000600000000000088f1ff1888f1ff1808fffff088f1ff1881ff1f80888ffff888fffff80000a0000000a0000000a00000000000000000000006000000060000000060000000000008fffff008fffff00033330008fffff00fffff8088fffff8083333800099a0000009a0000000a000000000000000000000060000000600000000600000000000003333000033330007000070073333000033337008f1ff10003333000009a0000000a0000000a0000000000000000000000060000006000000006000000000000070070000700070000000000000070000007000077333700070070000aaa0000009a0000000a0000000000000000000000060000006000000006000555555550000000000000000000000000000000000000000008888004999999449999994499909940300b0b0666566650300b0b000000000000000007000000055555555000000000000000000000000000000000000000008888880911111199111411991140919003b330067656765003b3300007700000770070007000007550000550000000000000000000000000aaaaaa0000000000878888091111119911191194940041902888820677067700288882000777070077700000000000055000055007000700499994000000000a998888a111111110888888091111119949404190000004408988880070007007898888707777770077000000000000055000055007000700050050000000000a988888a100000010888888091111119911409499400000008888980070007007888898707777770000070000000000055000055067706770005500000000000aaaaaaaa111111110888888091111119911191199140049908898880000000000889888007777770000007700000000055555555567656760050050000000000a980088a144444410088880091111119911411199140411902888820000000000288882007077700000707700700007055555555566656660005500004999940a988888a14444441000000004999999449999994440049940028820000000000002882000000000070000000000000005777777557777777777777777777777577cccccccccccccccccccc7757777775555555555555555555555555550000000777777000000000000000000000000077777777777777777777777777777777777cccccccccccccccccc777777777775555555555555550055555556670000077777777000777770000000000000000777c77777777ccccc777777ccccc7777777cccccccccccccccccc77777777777555555555555550000555555677770007777777700776670000000000000000077cccc77777cccccccc77cccccccc7777777cccccccccccccccc7777777cc777555555555555500000055555666000007777337707677700000000000000000077cccc7777cccccccccccccccccccc777777cccccccccccccccc777777cccc775555555555550000000055555500000077773377077660000777770000000000777cc77777cc77ccccccccccccc7cc77777cccccccccccccccccc77777cccc7755555555555000000000055566700000737733370777700007777670077000007777777777cc77cccccccccccccccc77777cccccccccccccccccc77777c7cc77555555555500000000000055677770007333bb370000000000000077007777705777777577cccccccccccccccccccc7777cccccccccccccccccccc7777cccc77555555555000000000000005666000000333bb3000000000000000000007777777cccc7777cccccccccccccccccccc77577777777777777777777775777ccc775555555550000000000000050000066603333330000000000000000000000000777ccc7777cccccccccccccccccccc77777777777777777777777777777cc7775055555555000000000000550007777603b333300000000000ee0ee000000000777ccc7777cc7cccccccccccc77ccc777777ccc7777777777ccc7777777cc77755550055555000000000055500000766033333300000000000eeeee00000003077ccc77777ccccccccccccccc77ccc77777ccccc7c7777ccccccc77777ccc777555500555555000000005555000000550333b33000000000000e8e00000000b077ccc777777cccccccc77cccccccc777777ccccccc7777c7ccccc77777cccc7755555555555550000005555500000666003333000000b00000eeeee000000b30777cc7777777ccccc777777ccccc77777777ccc7777777777ccc777777cccc775505555555555500005555550007777600044000000b000000ee3ee003000b00777cc777777777777777777777777777777777777777777777777777777cc7775555555555555550055555550000076600044000030b00300000b00000b0b30077cccc77577777777777777777777775577777777777777777777775577777755555555555555555555555550000005500999900030330300000b000003033005777755777577775077777777777777777777770077777700000000000000000cccccccc000000000000000000000000000000000000000000000000000000007777777777777777700007770000777000007777700077770000000000000000c77ccccc000000000000000000000000000000000000000000000000000000007777cc7777cc777770cc777cccc777ccccc7770770c777070000000000000000c77cc7cc00000000000000000000000000000000000000000000000000000000777cccccccccc77770c777cccc777ccccc777c0770777c070000000000000000cccccccc0000000000000000000000000000600000000000000000000000000077cccccccccccc77707770000777000007770007777700070002eeeeeeee2000cccccccc0000000000000000000000000006060000000000000000000000000057cc77ccccc7cc7577770000777000007770000777700007002eeeeeeeeee200cc7ccccc00000000000000000000000000d00060000000000000000000000000577c77ccccccc7757000000000000000000c000770000c0700eeeeeeeeeeee00ccccc7cc0000000000000000000000000d00000c000000000000000000000000777cccccccccc7777000000000000000000000077000000700e22222e2e22e00cccccccc000000000000000000000000d000000c000000000000000000000000777cccccccccc7777000000000000000000000077000000700eeeeeeeeeeee000000000000000000000000000000000c0000000c000600000000000000000000577cccccccccc7777000000c000000000000000770cc000700e22e2222e22e00000000000000000000000000000000d000000000c060d000000000000000000057cc7cccc77ccc7570000000000cc0000000000770cc000700eeeeeeeeeeee0000000000000000000000000000000c00000000000d000d00000000000000000077ccccccc77ccc7770c00000000cc00000000c0770000c0700eee222e22eee0000000000000000000000000000000c0000000000000000000000000000000000777cccccccccc7777000000000000000000000077000000700eeeeeeeeeeee005555555506666600666666006600c000666666000666660066666600666666007777cc7777cc777770000000000000000000000770c0000700eeeeeeeeeeee00555555556666666066666660660c000066666660666666606666666066666660777777777777777770000000c0000000000000077000000700ee77eee7777e00555555556600066066000000660000006600000066000000006600006600000057777577775577757000000000000000000000077000c007077777777777777055555555dd000000dddd0000dd000000dddd0000ddddddd000dd0000dddd0000000000000000000070000000000000000000000770000007007777005000000000000005dd000dd0dd000000dd0000d0dd000000000000d000dd0000dd00000000aaaaaaaaaaaa00700000000000000000000007700c0007070000705500000000000055ddddddd0dddddd00ddddddd0dddddd00ddddddd000dd0000dddddd000a999999999999a0700000000000c00000000007700000077077000755500000000005550ddddd00ddddddd0ddddddd0ddddddd00ddddd0000dd0000ddddddd0a99aaaaaaaaaa99a7000000cc0000000000000077000cc077077bb07555500000000555500000000000000000000000000000000000000000000000000000000a9aaaaaaaaaaaa9a7000000cc0000000000c00077000cc07700bbb0755555555555555550000000000000c000000000000000000000000000000c00000000000a99999999999999a70c00000000000000000000770c00007700bbb075555555555555555000000000000c00000000000000000000000000000000c0000000000a99999999999999a700000000000000000000007700000070700007055555555555555550000000000cc0000000000000000000000000000000000c000000000a99999999999999a07777777777777777777777007777770007777005555555555555555000000000c000000000000000000000000000000000000c000000000aaaaaaaaaaaaaaaa07777777777777777777777007777770004bbb00004b000000400bbb00000000c0000000000000000000000000000000000000c000000000a49494a11a49494a70007770000077700000777770007777004bbbbb004bb000004bbbbb0000000100000000000000000000000000000000000000c00c000000a494a4a11a4a494a70c777ccccc777ccccc7770770c7770704200bbb042bbbbb042bbb00000000c0000000000000000000000000000000000000001010c00000a49444aaaa44494a70777ccccc777ccccc777c0770777c07040000000400bbb004000000000001000000000000000000000000000000000000000001000c0000a49999aaaa99994a7777000007770000077700077777000704000000040000000400000000000100000000000000000000000000000000000000000000010000a49444999944494a77700000777000007770000777700c0742000000420000004200000000000100000000000000000000000000000000000000000000001000a494a444444a494a7000000000000000000000077000000740000000400000004000000000000000000000000000000000000000000000000000000000000000a49499999999494a077777777777777777777770077777704000000040000000400000000001000000000000000000000000000000000000000000000000001000000000000000008242525252528452339200001323232352232323232352230000000000000000b302000013232352526200a282834252522323232323232300000000000000a20182920013232352363636462535353545550000005525355284525262b2000000000000425252526282828242528452525284525252525200000000000085868242845252525252b1006100b1b1b1b103b1b1b1b1b103b100000000000000111102000000a282425233000000a213233300009200008392000000000000110000a2000000a28213000000002636363646550000005525355252528462b2a300000000004252845262828382132323232323232352528452000000000000a201821323525284525200000000000000007300000000007300000000000000b343536300410000011362b2000000000000000000000000a2000000000000b302b2002100000000a282000000000000000000560000005526365252522333b28292001111024252525262019200829200000000a282135252520000000000000000a2828242525252840000000000000000b10000000000b1000000000000000000b3435363930000b162273737373737373737374711000061000000110000b100b302b20000006182000000000000000000000000005600005252338282828201a31222225252525262820000a200111111000082834252520000000000000093a382824252525252000061000011000000000011000000001100000000000000000000020182001152222222222222222222222232b200000000b302b200000000b10000000000a200000000000000009300000000000000846282828283828282132323528452526292000000112434440000a28242528400000000000000a2828382428452525200000000b302b2936100b302b20061007293a30000000000000000b1a282931252845252525252232323232362b20000000000b10000001100000000000000000000000093000086820000a3000000005262828201a200a282829200132323236211111111243535450000b31252525200000000000000008282821323232323820000a300b1a382930000b100000000738283931100000000000011a382821323232323528462829200a20173b20061000000000000b302b2000061000000000000a385828286828282828293000000526283829200000000a20000000000005222222232263636460000b34252525200000011111111a3828201b1b1b1b1b182938282930082820000000000000000b100a282721100000000b372828283b12222223213233361000086920000000000100000000000b1000000000000000086938282828201920000a20182a37686526282829300000000000000000000005252845252328283920000b34284525200008612222232828382829300000000828282828283829200000000000061001100a382737200000000b373a2829211525284628382a2000000a2000000000000021111111111111111111111110061828282a28382820000000000828282825262829200000000000000000000000052525252526201a2000000b34252525200000113235252225353536300000000828300a282828201939300001100000072828292b1039300000000b100a282125223526292000000000000a3000000000043535353535353535353535363b2008282920082829200061600a3828382a284620000000000000000000000000000528452525262920000111111425252520000a28282132362b1b1b1b1000000009200000000a28282828293b372b2000073820100110382a30000001100828213621013336100000000000082930000000002828382828202828282828272b20083820000a282d3000717f38282920000526200000000000093000000000000005252525284620000b312223213528452000000828392b30300000000002100000000000000000082828282b303b20000b1a282837203820193000072a38292b16271000000000000930000838200000000b1a282820182b1a28283a28273b200828293000082122232122232820000a3233300000000000082920000000000002323232323330000b342525232135252000000a28200b37300000000a37200000010000000111111118283b373b200a300008282730392008283007382830011629300000000000082000082829200000000009261a28200008261008282000001920000000213233342846282243434000000000000000082000085860000008382829200000000b3425284523213230000100082000082000000a2820300002222321111125353630182829200008300009200b1030000a28200008282001262829200000000a3829200828200000000858600008282a3828293008292610082001000001222222252525232253535000000f3100000a3820000a2010000008292000000009300b3425252525222220400122232b200839321008683039300528452222262c000a28282820000a38210000000a3738000008293008292001362820000000000828300a3820100000000a282828292a2828283828282000000343434344442528452525252622535350000001263000083829300008200c1008210d3e300a38200b3425252528452521232425262b28682827282820103820052525252846200000082829200008282320000008382930000a28201820000b1628393000000008282008282829300000000008382000000a28201820000000035353535454252525252528462253535000000032444008282820000829300002222223201828393b342525252525252525252525262b2b1b1b1132323526200845223232323232352522323233382825252525252525252525284522333b2822323232323526282820000b34252525252845252525252848452525262838242528452522333828292425223232352520000000000000000000000000000000000000000000000000000000000000000525252845262b2000000b1b1b142620023338276000000824233b2a282018283525252845252232323235262b1b10083921000a382426283920000b3422323232323232323232323232323526201821352522333b1b1018241133383828242840000000000000000000000000000000000000000000000000000000000000000525252525262b20000000000a242627682828392000011a273b200a382729200525252525233b1b1b1b11333000000825353536382426282410000b30382a2a2a1829200a2828382820182426200a2835262b1b10000831232b2000080014252000000000000a300000000000000000000000000000000000000000000000000528452232333b20000001100824262928201a20000b3720092000000830300002323525262b200000000b3720000a382828283828242522232b200b373928000000100110092a2829211a2133300a3825262b2000000a21333b20000868242520000000000000100009300000000000000000000000000000000000000000000525262122232b200a37672b2a24262838292000000b30300000000a3820300002232132333b200000000b303829300a2838292019242845262b200000000000000a2b302b2a36182b302b200110000825262b200000000b1b10000a283a2425200000000a30082000083000000000000000000000094a4b4c4d4e4f400000000525262428462b200a28303b2214262928300000000b3030000000000a203e3415252222232b200000000b30392000000829200000042525262b2000000000000000000b100a2828200b100b302b211a25262b200000000000000000092b3428400000000827682000001009300000000000000000095a5b5c5d5e5f500000000232333132362b221008203b2711333008293858693b3031111111111114222225252845262b200001100b303b2000000821111111142528462b2000000000000000000000000110176851100b1b3026184621111111100000061000000b3135200000000828382670082768200000000000000000096a6b6c6d6e6f60000000082000000a203117200a203b200010193828283824353235353535353535252845252525262b200b37200b303b2000000824353535323235262b20000110000000000000000b30282828372b26100b100525232122232b200000000000000b14200000000a28282123282839200000000000000000097a7b7c7d7e7f7000000009200110000135362b2001353535353539200a2000001828282829200b34252522323232362b261b30300b3030000000092b1b1b1b1b1b34262b200b372b20000001100000000b1a2828273b200000000232333132333b200001111000000b342000000868382125252328293a30000000000000000000000000000000000000000b372b200a28303b2000000a28293b3000000000000a2828382827612525252b1b1b1b173b200b30393b30361000000000000000000b34262b271b303b20000b302b211000000110092b100000000a3b1b1b1b1b1b10011111232110000b342000000a28212528452523282838600000000000000000000000000000000000080b303b20000820311111111008283b311111111110000829200928242528452000000a3820000b30382b37300000000000000000000b3426211111103b2000000b1b302b200b372b200000000000082b21000000000b31222522363b200b313858586829242525252526201828286000000000000000000000000000000000000b373b20000a21353535363008292b32222222232111102b20000a21323525200000001839200b3038282820000000011111111930011425222222233b20000100000b10000b303b200000000858682b27100000000b3425233b1b1000000b182018283001323525284629200a28200000000000000000000000000000000009300b100000000b1b1b1b1b100a200b323232323235363b100000000b1b1135200000000820000b30382839200000000222222328283432323232333b2000000329300000000b373b200000000a20182111111110000b31333b100a30061000000a28293f3123242522333020000820000000000000000000000000000000000829200001000410000000000000000b39310d30000a28200000000000000824200000086827600b30300a282760000005252526200828200a30182a2006100a362820000000000b100000093a382838222222232b20000b1b1000083000000860000122222526213331222328293827600000000000000000000000000000000017685a31222321111111111002100b322223293000182930000000080a301131000a383829200b373000083920000005284526200a28282828392000000008262839321000000000000a3828282820152845262b261000093000082a300a3821000135252845222225252523201838200000000000000000000000000000000828382824252522222222232007100b352526282a38283820000000000838282320001828200000083000082010000005252526271718283820000000000a382628201729300000000a282828382828252528462b20000a38300a382018283821222324252525252525284525222223200000000000000000000000000000000";
let FLAGS: NSString = "00000000000000000000000000000000040200000000000000000002000000000303030303030303040404020200000003030303030303030404040202020202000013131313020203020202020200020000131313130202040202020202020200001313131300040402020202020202000013131313000000020202020202020000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
let FONTATLAS: NSString = "11111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111101011111010111110001111101011111001111111011111110111111101111110101111111111111111111111111111111111111110111111111111110111111010111110001111100111111110111110011111101111111011111111101111110111111101111111111111111111111111111111011111111111111101111111111111101011111100111111011111100111111111111110111111111011111000111110001111111111111000111111111111110111111111111111111111111111111000111110001111101111111010111111111111101111111110111111011111110111111101111111111111111111111101111111111111110111111111111110101111110111111010111110001111111111111101111111011111101011111111111110111111111111111101111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100011111001111110001111100011111010111110001111101111111000111110001111100011111111111111111111111011111111111110111111100011111010111111011111111011111110111110101111101111111011111111101111101011111010111111011111110111111101111110001111110111111110111110101111110111111000111111001111100011111000111110001111111011111000111110001111111111111111111110111111111111111110111111001111101011111101111110111111111011111110111111101111101011111110111110101111111011111101111111011111110111111000111111011111111111111000111110001111100011111000111111101111100011111000111111101111100011111110111111111111101111111110111111111111101111111101111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111101011111000111110011111100011111001111110001111100011111000111110101111100011111000111110101111101111111000111110011111110011111010111110101111100111111011111110101111100111111001111110111111101011111101111111011111100111111011111110001111101011111010111110111111100011111010111110111111101011111011111110111111101011111000111111011111110111111010111110111111101011111010111110101111110011111010111110001111100011111001111110001111101111111000111110101111100011111001111110101111100011111010111110101111100111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100111111011111111001111110111111111111110001111110111111000111111001111100011111010111110101111101011111010111110101111100011111011111111011111111011111010111111111111101011111010111110101111101111111101111110101111101011111010111111011111100011111110111110111111110111111110111111111111111111111000111110011111100111111110111111011111101011111000111110001111101011111110111110111111101111111101111111101111111111111111111110111111110011111010111110011111110111111100111111011111100011111010111110001111100011111001111111101111110011111111111110001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110111111000111110001111110011111001111110001111100011111100111110101111100011111000111110101111101111111000111110011111110011111110111110101111101011111011111110101111101111111011111110111111101011111101111111011111101011111011111110001111101011111010111111111111100011111001111110111111101011111001111110011111101111111000111111011111110111111001111110111111101011111010111110101111111111111010111110101111101111111010111110111111101111111010111110101111110111111101111110101111101111111010111110101111101011111111111110101111100011111100111110001111100011111011111110001111101011111000111110011111101011111000111110101111101011111001111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111110001111110111111000111111001111100011111010111110101111101011111010111110101111100011111100111111011111100111111111111111111111101011111010111110101111101111111101111110101111101011111010111110101111101011111110111111011111110111111101111111101111110111111000111110101111100111111000111111011111101011111010111110101111110111111000111111011111100111111101111111001111100011111010111110111111100111111010111111101111110111111010111110001111100011111010111111101111101111111101111111011111110111111011111110101111101111111100111110101111100111111101111111001111110111111000111110101111100011111000111111001111110111111001111111111111100011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111000000010101010101111101100000110111011111011111110001111001001111000111110001111100011110000011000000011110001110000011111011110000000110101011000000010011100111011101110000111000101110000011100100111100011110000011000110010100010111101111001110011100011100000001010101010100010100111001011101111100011110000011100000110001000110000011000000010011100100000001111011110010100110000011000000011010101101000101000100011101110110000111100000111100011110010011110001111010101100011001011111011000111100111001110001110000000101010101100000111000001101110111111101111100011111101111110001111101011110100011100000110000000110001111100000111110111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111100000111110111110000011100000111111111111111111100000110000000101010101111111111111111111111111111111111111111111111111111111110011000111000111110001110001000101011111011101110010100111111111010101011111111111111111111111111111111111111111111111110101010100111001000000011110111100111001101101011010101100010001000000010101010111111111111111111111111111111111111111111111111111111111001100011000001111000111001110011111101111011101001010011111111101010101111111111111111111111111111111111111111111111111111111111000001110111011100000111000001111111111111111111000001100000001010101011111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111111";

let pallete: [(UInt8, UInt8, UInt8)] = [
    (0, 0, 0),
    (29, 43, 83),
    (126, 37, 83),
    (0, 135, 81),
    (171, 82, 54),
    (95, 87, 79),
    (194, 195, 199),
    (255, 241, 232),
    (255, 0, 77),
    (255, 163, 0),
    (255, 236, 85),
    (0, 228, 54),
    (41, 173, 255),
    (131, 118, 156),
    (255, 119, 168),
    (255, 204, 170),
];

public struct PixelData {
    var a: UInt8
    var r: UInt8
    var g: UInt8
    var b: UInt8
}

extension UIImage {
    convenience init?(pixels: [PixelData], width: Int, height: Int) {
        guard width > 0 && height > 0, pixels.count == width * height else { return nil }
        var data = pixels
        guard let providerRef = CGDataProvider(data: Data(bytes: &data, count: data.count * MemoryLayout<PixelData>.size) as CFData)
        else { return nil }
        guard let cgim = CGImage(
            width: width,
            height: height,
            bitsPerComponent: 8,
            bitsPerPixel: 32,
            bytesPerRow: width * MemoryLayout<PixelData>.size,
            space: CGColorSpaceCreateDeviceRGB(),
            bitmapInfo: CGBitmapInfo(rawValue: CGImageAlphaInfo.premultipliedFirst.rawValue),
            provider: providerRef,
            decode: nil,
            shouldInterpolate: true,
            intent: .defaultIntent)
        else { return nil }
        self.init(cgImage: cgim)
    }
}

struct ContentView: View {
    @State var screenUIImage: UIImage = UIImage(pixels: [PixelData(a: 255,r: 0,g: 0,b: 0)], width: 1, height: 1)!;
    
    @State var digitalCrown: Float = 0;
    @State var crownActionActive = false;
    
    @State var dragOffset = CGSize.zero {
        willSet {
            librustic_set_btn(0, 0); // left
            librustic_set_btn(1, 0); // right
            librustic_set_btn(2, 0); // up
            librustic_set_btn(3, 0); // down
            if newValue.height < -15 {
                librustic_set_btn(2, 1);
            } else if newValue.height > 15 {
                librustic_set_btn(3, 1);
            }
            if newValue.width < -15 {
                librustic_set_btn(0, 1);
            } else if newValue.width > 15 {
                librustic_set_btn(1, 1);
            }
        }
    };
    
    func ptrToPixelData(pixels: UnsafeMutableRawPointer) -> [PixelData] {
        let buf = pixels.bindMemory(to: UInt8.self, capacity: 128*128);
        let arr = Array(UnsafeBufferPointer(start: buf, count: 128*128));
        return arr.map({el in
            return PixelData(a: 255, r: pallete[Int(el)].0, g: pallete[Int(el)].1, b: pallete[Int(el)].2)
        });
    }
    var body: some View {
        Image(uiImage: screenUIImage).resizable().aspectRatio(contentMode:.fill)
            .padding()
            .focusable(true)
            .digitalCrownRotation(detent: $digitalCrown,
                                  from: -100,
                                  through: 100,
                                  by: 0.01,
                                  sensitivity: .low,
                                  isContinuous: true,
                                  onChange: {event in
                if (event.velocity == 0 || crownActionActive) {return;}
                crownActionActive = true;
                let btn: CChar = event.velocity > 0 ? 5 : 4;
                librustic_set_btn(btn, 1);
                Timer.scheduledTimer(withTimeInterval: 0.033, repeats: false, block: {_ in
                    librustic_set_btn(btn, 0);
                    crownActionActive = false;
                });
            }
            )
            .gesture(
                DragGesture()
                    .onChanged {gesture in
                        dragOffset = gesture.translation;
                    }
                    .onEnded {_ in dragOffset = .zero}
            )
            .task {
                let map_p = UnsafeMutablePointer<CChar>(mutating: MAPDATA.utf8String);
                let sprites_p = UnsafeMutablePointer<CChar>(mutating: SPRITES.utf8String);
                let flags_p = UnsafeMutablePointer<CChar>(mutating: FLAGS.utf8String);
                let fontatlas_p = UnsafeMutablePointer<CChar>(mutating: FONTATLAS.utf8String);
                librustic_start(map_p, sprites_p, flags_p, fontatlas_p);
                Timer.scheduledTimer(withTimeInterval: 0.033, repeats: true, block: {_ in
                    librustic_next_tick();
                    let screen = ptrToPixelData(pixels:librustic_render_screen());
                    screenUIImage = UIImage(pixels: screen, width: 128, height: 128) ?? screenUIImage;
                })
            }
    }
}
